<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ì§€ê°‘ ì—°ê²°</title>
  <style>
    body { text-align: center; padding-top: 50px; font-family: sans-serif; }
    .btn {
      font-size: 20px;
      padding: 14px 28px;
      background: #007aff;
      color: white;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      display: inline-block;
      margin-top: 16px;
    }
    .warn {
      margin-top: 20px;
      font-size: 14px;
      color: #d00;
    }
    .code {
      font-size: 12px;
      margin-top: 20px;
      color: #333;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <h2>Web3 ì§€ê°‘ ì—°ê²°</h2>
  <button id="connect-button" class="btn">ì§€ê°‘ ì—°ê²° ë° ì„œëª…</button>
  <div id="result-container"></div>

  <script src="https://leeeunsuuu.github.io/wallet-dapp/ethers.umd.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const btn = document.getElementById("connect-button");
      const result = document.getElementById("result-container");

      if (!window.ethers) {
        alert("ethers.js ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        return;
      }

      function encodeBase64(obj) {
        return btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
      }

      btn.addEventListener("click", async () => {
        try {
          if (!window.ethereum) {
            alert("MetaMask ì•±ì˜ ë¸Œë¼ìš°ì €ì—ì„œ ì´ í˜ì´ì§€ë¥¼ ì—´ì–´ì£¼ì„¸ìš”.");
            return;
          }

          const provider = new ethers.providers.Web3Provider(window.ethereum);
          await provider.send("eth_requestAccounts", []);
          const signer = provider.getSigner();
          const address = await signer.getAddress();
          const message = "ì´ ê³„ì•½ì„œì— ë™ì˜í•˜ì—¬ ì„œëª…í•©ë‹ˆë‹¤.";
          const signature = await signer.signMessage(message);

          const combined = { address, sig: signature };
          const encoded = encodeURIComponent(encodeBase64(combined));
          const deeplink = `anb://signature?data=${encoded}`;

          console.log("ğŸ“¬ ë”¥ë§í¬:", deeplink);

          result.innerHTML = `
            <p>âœ… ì„œëª…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br><strong>ì•„ë˜ <u>íŒŒë€ ë²„íŠ¼</u>ì„ ëˆŒëŸ¬ ì•±ìœ¼ë¡œ ëŒì•„ê°€ ì£¼ì„¸ìš”.</strong></p>
            <button class="btn" onclick="window.location.href='${deeplink}'">ğŸ‘‰ ì•±ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            <p class="warn">âš ï¸ ë°˜ë“œì‹œ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ê³„ì•½ì´ ì™„ë£Œë©ë‹ˆë‹¤.</p>
            <div class="code">ë”¥ë§í¬ ì£¼ì†Œ:<br/><code>${deeplink}</code></div>
          `;
        } catch (err) {
          alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
          console.error(err);
        }
      });
    });
  </script>
</body>
</html>
